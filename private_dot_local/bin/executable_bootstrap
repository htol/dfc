#!/bin/bash

set -e

. $HOME/.config/common_env

LOCAL="$HOME/.local"
CONF="$HOME/.config"
system_type=$(uname -s)

# ---------------------------------------------------------------------------
# Usage
# ---------------------------------------------------------------------------
usage() {
    echo "Usage: bootstrap [-r] [-u <component>]"
    echo "  -r              full refresh (run all installers)"
    echo "  -u <component>  update specific component"
    echo ""
    echo "Components: neovim, uv, proto, fnm, ansible, sdkman, fisher, chezmoi"
    exit 0
}

REFRESH=false
COMPONENT=""

while getopts ":ru:h" flag; do
    case "${flag}" in
        r) REFRESH=true ;;
        u) COMPONENT="${OPTARG}" ;;
        h) usage ;;
    esac
done

# ---------------------------------------------------------------------------
# Installers
# ---------------------------------------------------------------------------

install_neovim() {
    # Downloads both tar.gz and appimage: tar.gz for systems with compatible
    # glibc, appimage (extracted) as fallback when glibc is too old.
    echo "== Getting neovim build"
    rm -rf "${LOCAL}/nvim"
    mkdir -p "${LOCAL}/nvim"
    cd "${LOCAL}/nvim"
    local ver="stable"
    curl -LO "https://github.com/neovim/neovim/releases/download/${ver}/nvim-linux-x86_64.tar.gz"
    tar xvfz nvim-linux-x86_64.tar.gz
    curl -LO "https://github.com/neovim/neovim/releases/download/${ver}/nvim-linux-x86_64.appimage"
    chmod u+x nvim-linux-x86_64.appimage
    ./nvim-linux-x86_64.appimage --appimage-extract
    cd "$HOME"
}

install_uv() {
    echo "== Installing uv"
    curl -LsSf https://astral.sh/uv/install.sh | sh
    uv python install 3.13
    uv python pin --global 3.13
    uv venv --clear --no-project --seed "${HOME}/.local/venv/neovim"
    "${HOME}/.local/venv/neovim/bin/python3" -m pip install -U pip neovim
}

install_proto() {
    echo "== Installing proto"
    curl -fsSL https://moonrepo.dev/install/proto.sh | bash -s -- --no-profile
    proto install node lts
    proto install bun
}

install_fnm() {
    # disabled: replaced by proto
    echo "== [skip] fnm is disabled (use proto instead)"
    return 0

    echo "== Installing fnm, Node, yarn"
    export FNM_DIR="${FNM_DIR:-${LOCAL}/fnm}"
    export PATH=$FNM_DIR:$PATH
    curl -fsSL https://github.com/Schniz/fnm/raw/master/.ci/install.sh | bash -s -- --skip-shell --install-dir "${LOCAL}/fnm"
    eval "$(fnm env --shell=bash)"
    fnm install --lts
    fnm default lts-latest
    local npm_packages=(
        npm yarn npx neovim
        pyright
        @vue/language-server
        emmet-ls
        yaml-language-server
        vscode-langservers-extracted
        typescript
        typescript-language-server
    )
    npm install --global "${npm_packages[@]}"
}

install_ansible() {
    # Only clones the repo. Venv setup and loading is handled by the
    # fish function load-ansible — run it when you need ansible.
    echo "== Installing ansible"
    git -C "${LOCAL}/ansible" pull 2>/dev/null || \
        git clone --depth 1 https://github.com/ansible/ansible.git "${LOCAL}/ansible"
}

install_sdkman() {
    echo "== Installing/updating sdkman"
    if [[ ! -f "${HOME}/.local/sdkman/bin/sdkman-init.sh" ]]; then
        curl -s "https://get.sdkman.io" | bash
    else
        source "${HOME}/.local/sdkman/bin/sdkman-init.sh"
        sdk selfupdate force
    fi
}

install_fisher() {
    echo "== Installing fisher and plugins"
    /usr/bin/env fish -c '
        curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
        fisher install jorgebucaran/fisher jomik/fish-gruvbox jethrokuan/fzf
    '
}

install_chezmoi() {
    echo "== Installing chezmoi"
    sh -c "$(curl -fsLS get.chezmoi.io/lb)"
}

configure_macos() {
    local PREF="$HOME/Library/Preferences"
    echo "== Configuring macOS defaults"

    ###########################################################################
    # Trackpad, mouse, keyboard, Bluetooth accessories, and input             #
    ###########################################################################

    # Trackpad: enable tap to click for this user and for the login screen
    defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
    defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

    # Disable "natural" (Lion-style) scrolling
    defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false

    # Increase sound quality for Bluetooth headphones/headsets
    defaults write com.apple.BluetoothAudioAgent "Apple Bitpool Min (editable)" -int 40

    # Set a fast keyboard repeat rate
    defaults write NSGlobalDomain KeyRepeat -int 2
    defaults write NSGlobalDomain InitialKeyRepeat -int 15

    # Show language menu in the top right corner of the boot screen
    sudo defaults write /Library/Preferences/com.apple.loginwindow showInputMenu -bool true

    # Shortcuts
    defaults write -g NSUserKeyEquivalents -dict-add "Lock Screen" "@l"
    #defaults write com.apple.universalaccess com.apple.custommenu.apps -array-add NSGlobalDomain

    ###########################################################################
    # iTerm2                                                                  #
    ###########################################################################
    #defaults write com.googlecode.iterm2 "PrefsCustomFolder" -string "$HOME/.config/iterm"
    #defaults write com.googlecode.iterm2 "LoadPrefsFromCustomFolder" -bool true
    if [[ -f "${PREF}/com.googlecode.iterm2.plist" ]]; then
        /usr/libexec/PlistBuddy -c 'set "New Bookmarks":0:"Scrollback Lines" 50000' \
            "$PREF/com.googlecode.iterm2.plist"
    fi

    ###########################################################################
    # Finder                                                                  #
    ###########################################################################

    # Finder: allow quitting via ⌘ + Q; doing so will also hide desktop icons
    defaults write com.apple.finder QuitMenuItem -bool true

    # Set ~/dev as the default location for new Finder windows
    # mkdir -p "${HOME}/dev/"
    # defaults write com.apple.finder NewWindowTarget -string "PfLo"
    # defaults write com.apple.finder NewWindowTargetPath -string "file://${HOME}/dev/"

    # Finder: show hidden files by default
    #defaults write com.apple.finder AppleShowAllFiles -bool true

    # When performing a search, search the current folder by default
    defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

    # Disable the warning when changing a file extension
    defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

    # Avoid creating .DS_Store files on network or USB volumes
    defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
    defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

    # Use list view in all Finder windows by default
    # Four-letter codes for the other view modes: `icnv`, `clmv`, `Flwv`
    defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

    # Show the ~/Library folder
    chflags nohidden ~/Library

    # Show the /Volumes folder
    sudo chflags nohidden /Volumes

    ###########################################################################
    # Dock, Dashboard, and hot corners                                        #
    ###########################################################################

    # Minimize windows into their application's icon
    defaults write com.apple.dock minimize-to-application -bool true

    # Change minimize/maximize window effect
    defaults write com.apple.dock mineffect -string "scale"

    # Remove the auto-hiding Dock delay
    defaults write com.apple.dock autohide-delay -float 0

    # Automatically hide and show the Dock
    defaults write com.apple.dock autohide -bool true

    ###########################################################################
    # Mail                                                                    #
    ###########################################################################

    # Disable send and reply animations in Mail.app
    # defaults write com.apple.mail DisableReplyAnimations -bool true
    # defaults write com.apple.mail DisableSendAnimations -bool true

    # Copy email addresses as `foo@example.com` instead of `Foo Bar <foo@example.com>` in Mail.app
    ##defaults write com.apple.mail AddressesIncludeNameOnPasteboard -bool false

    # Add the keyboard shortcut ⌘ + Enter to send an email in Mail.app
    ##defaults write com.apple.mail NSUserKeyEquivalents -dict-add "Send" "@\U21a9"

    # Display emails in threaded mode, sorted by date (oldest at the top)
    ##defaults write com.apple.mail DraftsViewerAttributes -dict-add "DisplayInThreadedMode" -string "yes"
    ##defaults write com.apple.mail DraftsViewerAttributes -dict-add "SortedDescending" -string "yes"
    ##defaults write com.apple.mail DraftsViewerAttributes -dict-add "SortOrder" -string "received-date"

    # Disable inline attachments (just show the icons)
    ##defaults write com.apple.mail DisableInlineAttachmentViewing -bool true

    ###########################################################################
    # Kill affected applications                                              #
    ###########################################################################

    for app in "Activity Monitor" "Dock" "Finder" "Mail"; do
        killall "${app}" &> /dev/null || true
    done
}

install_all() {
    if [ "$system_type" = "Linux" ]; then
        [[ "$REFRESH" == true || ! -d "${HOME}/.local/nvim" ]] && install_neovim
    fi

    if [[ "$system_type" = "Linux" || "$system_type" = "Darwin" ]]; then
        [[ "$REFRESH" == true || ! -f "${HOME}/.local/bin/uv" ]]      && install_uv
        [[ "$REFRESH" == true || ! -d "${PROTO_HOME}" ]]                && install_proto
        [[ "$REFRESH" == true || ! -d "${LOCAL}/ansible" ]]            && install_ansible
        [[ ! -d "${CONF}/nvim/vim_undodir" ]]                          && mkdir -p "${CONF}/nvim/vim_undodir"
        [[ "$REFRESH" == true || ! -f "${CONF}/fish/functions/fisher.fish" ]] && install_fisher
        [[ "$REFRESH" == true || ! -f "${HOME}/.local/bin/chezmoi" ]] && install_chezmoi
        [[ "$REFRESH" == true ]] && install_sdkman
    fi

    if [ "$system_type" = "Darwin" ]; then
        configure_macos
    fi
}

# ---------------------------------------------------------------------------
# Entry point
# ---------------------------------------------------------------------------

cd "$HOME"

if [[ -n "$COMPONENT" ]]; then
    case "$COMPONENT" in
        neovim)  install_neovim ;;
        uv)      install_uv ;;
        proto)   install_proto ;;
        fnm)     install_fnm ;;
        ansible) install_ansible ;;
        sdkman)  install_sdkman ;;
        fisher)  install_fisher ;;
        chezmoi) install_chezmoi ;;
        macos)   configure_macos ;;
        *)       echo "Unknown component: $COMPONENT"; usage ;;
    esac
else
    install_all
fi
