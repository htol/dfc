#!/bin/bash
# Modify .prototools to update work configuration while preserving versions

# Read the existing file content from stdin
content=$(cat)

# Extract version lines (before any section headers)
versions=$(echo "$content" | awk '/^\[/{exit} /^[a-z-]+ = /{print}')

# If no versions found, use current installed versions
if [ -z "$versions" ]; then
    versions=$(cat <<'VERSIONS'
node = "24.13.1"
bun = "1.3.9"
npm = "11.10.1"
VERSIONS
)
fi

# Output: versions + work config
echo "$versions"
echo ""

{{- if index . "is_work" }}
{{- $workConfig := include (joinPath .chezmoi.homeDir ".config/work/config.toml") | fromToml }}
cat <<'WORK_CONFIG'
# Work configuration
[tools.npm]
registry-url = "{{ $workConfig.npm_registry }}"
WORK_CONFIG
{{- else }}
cat <<'PERSONAL_CONFIG'
# Personal configuration
# [tools.npm]
# registry-url = "https://registry.npmjs.org/"
PERSONAL_CONFIG
{{- end }}

cat <<'SETTINGS'

[settings]
telemetry = false
SETTINGS
